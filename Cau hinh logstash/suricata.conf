# /etc/logstash/conf.d/01-suricata-pipeline.conf

# ======================== INPUT ========================
# Thiết lập một cổng vào duy nhất để nhận dữ liệu từ tất cả các Beats (Filebeat, etc.)
# Đây là cách tiếp cận hiện đại và có khả năng mở rộng tốt nhất.
input {
  beats {
    port => 5044
  }
}

# ======================== FILTER ========================
# Đây là nơi xử lý logic chính.
# Chúng ta chỉ áp dụng bộ lọc này cho các sự kiện đến từ module "suricata" của Filebeat.
filter {
  if [event][module] == "suricata" {

    # 1. Gắn tag cho các sự kiện là cảnh báo (alert)
    if [event][kind] == "alert" {
      mutate {
        add_tag => ["suricata_alert"]
      }

      # 2. Phân loại và gắn tag mức độ nghiêm trọng (severity)
      # Điều này rất hữu ích để tạo visualization và cảnh báo trong Kibana.
      if [suricata][alert][severity] <= 2 {
        mutate { add_tag => ["severity_critical"] }
      } else if [suricata][alert][severity] == 3 {
        mutate { add_tag => ["severity_medium"] }
      } else {
        mutate { add_tag => ["severity_low"] }
      }

      # 3. Gắn tag giao thức dựa vào nội dung signature (tùy chọn nhưng rất hữu ích)
      if [suricata][alert][signature] {
        if [suricata][alert][signature] =~ /(?i)icmp/ { mutate { add_tag => ["protocol_icmp"] } }
        if [suricata][alert][signature] =~ /(?i)dns/ { mutate { add_tag => ["protocol_dns"] } }
        if [suricata][alert][signature] =~ /(?i)ssh/ { mutate { add_tag => ["protocol_ssh"] } }
        if [suricata][alert][signature] =~ /(?i)ftp/ { mutate { add_tag => ["protocol_ftp"] } }
        if [suricata][alert][signature] =~ /(?i)smb/ { mutate { add_tag => ["protocol_smb"] } }
      }
    }

    # 4. Làm giàu dữ liệu địa lý (GeoIP) cho cả IP nguồn và IP đích
    # Yêu cầu cài đặt database GeoIP cho Logstash.
    if [source][ip] {
      geoip {
        source => "[source][ip]"
        target => "[source][geo]"
      }
    }

    if [destination][ip] {
      geoip {
        source => "[destination][ip]"
        target => "[destination][geo]"
      }
    }

    # 5. Dọn dẹp các trường metadata không cần thiết để giữ cho document gọn gàng
    # Giúp tiết kiệm dung lượng lưu trữ trên Elasticsearch.
    mutate {
      remove_field => ["agent", "ecs", "host", "input", "log", "@version"]
    }
  }
}

# ======================== OUTPUT ========================
# Gửi dữ liệu đã được xử lý và làm giàu đến các đích khác nhau.
output {
  # Chỉ gửi các sự kiện của Suricata vào index "suricata-*"
  if [event][module] == "suricata" {
    elasticsearch {
      hosts => ["http://localhost:9200"] # <-- Sửa IP nếu Elasticsearch ở máy chủ khác
      index => "suricata-%{+YYYY.MM.dd}"
      
      # Bỏ comment và điền thông tin nếu Elasticsearch của bạn có xác thực
      #user => "elastic"
      #password => "YOUR_PASSWORD"
    }
  }

  # (Tùy chọn) In ra màn hình console để gỡ lỗi trong quá trình phát triển.
  # Hãy comment out dòng này khi đưa vào môi trường production.
  # stdout {
  #   codec => rubydebug
  # }
}
